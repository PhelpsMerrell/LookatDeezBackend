name: Build and deploy Azure Functions (.NET 8)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'LookatDeezBackend/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.204'
  PROJECT_FILE: 'LookatDeezBackend/LookatDeezBackend.csproj'
  PUBLISH_DIR: 'published'
  AZURE_FUNCTIONAPP_NAME: 'lookatdeez-functions'
  # TODO: set your actual resource group name:
  AZURE_RESOURCE_GROUP: 'REPLACE_WITH_YOUR_RG_NAME'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj','**/packages.lock.json') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore & Publish
        shell: bash
        run: |
          set -euo pipefail
          dotnet --version
          dotnet restore "${{ env.PROJECT_FILE }}"
          dotnet publish "${{ env.PROJECT_FILE }}" \
            --configuration Release \
            --output "${{ env.PUBLISH_DIR }}"

      - name: Verify Functions package layout
        shell: bash
        run: |
          set -euo pipefail
          echo "Publish dir contents:"
          ls -la "${{ env.PUBLISH_DIR }}"
          echo "Looking for host.json at publish root..."
          test -f "${{ env.PUBLISH_DIR }}/host.json" || (echo "::error::host.json missing from publish output" && exit 1)
          echo "Looking for generated function.json files..."
          FOUND=$(find "${{ env.PUBLISH_DIR }}" -maxdepth 2 -name function.json | wc -l)
          if [ "$FOUND" -eq 0 ]; then
            echo "::error::No function.json files found. Ensure Worker.Sdk analyzer is referenced and you have at least one Function."
            exit 1
          fi
          find "${{ env.PUBLISH_DIR }}" -maxdepth 2 -name function.json -print

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_7535D8B89C4F4B719148B58C8FF35484 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_BEF8E29C85F848A199ECD77A7B703DD6 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_442E4247BBF54B478C9E86E6EFEB7D7F }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          slot-name: 'Production'
          package: '${{ env.PUBLISH_DIR }}'

      # Optional but handy: restart and re-sync triggers after deploy
      - name: Restart & Re-sync triggers
        if: always()
        uses: azure/cli@v2
        with:
          inlineScript: |
            az functionapp restart -g "${{ env.AZURE_RESOURCE_GROUP }}" -n "${{ env.AZURE_FUNCTIONAPP_NAME }}"
            az rest -m POST -u "https://management.azure.com/subscriptions/${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_442E4247BBF54B478C9E86E6EFEB7D7F }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.AZURE_FUNCTIONAPP_NAME }}/syncfunctiontriggers?api-version=2022-03-01"
